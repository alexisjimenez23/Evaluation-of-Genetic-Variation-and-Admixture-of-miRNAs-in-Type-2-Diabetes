---
title: "Admixture with hapmap refrences"
output: html_notebook
---
```{r}
knitr::opts_knit$set(root.dir = normalizePath("/Users/alexisjimenez/Desktop"))
```

```{r}
Merged_data <- read.csv("/Users/alexisjimenez/Desktop/merged_data.3.Q", header = TRUE)
write.csv(Merged_data, "/Users/alexisjimenez/Desktop/merged_data_output.csv", row.names = FALSE)
raw_data <- read.csv("/Users/alexisjimenez/Desktop/merged_data_output.csv", header = FALSE, stringsAsFactors = FALSE)

```

```{r}
#loading the data
Ref_ancestry <- read.table("merged_data.3.Q")
Ref_fam <- read.table("merged_data.fam", header=FALSE)
```

```{r}
#loading the libraries
library(tidyverse)
library(ggplot2)
library(data.table)

```

```{r}
#number of ancestry groups
K <- 3  

#loading Q file generated by admixture 
q_matrix <- - read.table("merged_data.3.Q")

# Rename columns 
colnames(q_matrix) <- paste0("Ancestry_", 1:K)

# Print first few rows
head(q_matrix)

```
```{r}
fam_data <- read.table("merged_data.fam", header=FALSE)

# rename first two columns 
fam_data <- fam_data[, 1:2]
colnames(fam_data) <- c("FID", "IID")

#print 
head(fam_data)

```
```{r}
# merge the fam and Q files
admixture_results <- cbind(fam_data, q_matrix)

# Print the first few rows
head(admixture_results)

```


```{r}
library(tidyverse)
library(data.table)

# Load merged fam file
fam_merged <- fread("merged_data.fam", header = FALSE)[, 1:2]
colnames(fam_merged) <- c("FID", "IID")

# Load sample data fam file 
fam_my_samples <- fread("qc-exome-pruned.fam", header = FALSE)[, 1:2]
colnames(fam_my_samples) <- c("FID", "IID")

# print
head(fam_merged)
head(fam_my_samples)

# Merge files 
admixture_results <- cbind(fam_merged, fread("merged_data.3.Q", header = FALSE))

# Rename population columns
K <- ncol(admixture_results) - 2 
colnames(admixture_results)[3:(K+2)] <- paste0("Ancestry_", 1:K)

# Label "My Sample" vs. "Reference"
admixture_results$SampleType <- ifelse(admixture_results$IID %in% fam_my_samples$IID, "My Sample", "Reference")

#print
head(admixture_results)

```
```{r}
hapmap_populations <- fread("relationships_w_pops_041510.txt", header = TRUE)


head(hapmap_populations)
```
```{r}
table(admixture_results$SampleType)
```
```{r}
# Reshape data for ggplot
admixture_long <- admixture_results %>%
  pivot_longer(cols = starts_with("Ancestry_"), names_to = "Ancestry", values_to = "Proportion")

```

```{r}
#install.packages(c("tidyverse", "ggplot2", "data.table"))

# Load required libraries
library(tidyverse)  
library(ggplot2)
library(data.table)

```

```{r}
# colors
ancestry_colors <- c(
  "Ancestry_1" = "#E69F00",  
  "Ancestry_2" = "#56B4E9",  
  "Ancestry_3" = "#009E73"   
)

ancestry_labels <- c(
  "Ancestry_1" = "African (AFR)",
  "Ancestry_2" = "East Asia (EAS) ",
  "Ancestry_3" = "European (CEU)"
)
 
ggplot(admixture_long, aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) + 
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions", x = "Sample", y = "Ancestry Proportion", fill = "Ancestry Group") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~SampleType, scales = "free_x")  


```

```{r}
ggplot(admixture_long %>% filter(SampleType == "My Sample"), 
       aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) +  
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions - PRYSMS Samples", 
       x = "Sample", y = "Ancestry Proportion", fill = "Ancestry Group") + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) 

```

```{r}

ancestry_colors <- c(
  "Ancestry_1" = "#E69F00",  
  "Ancestry_2" = "#56B4E9",  
  "Ancestry_3" = "#009E73"  
)


ggplot(admixture_long, aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) +  
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions", x = "Sample", y = "Ancestry Proportion") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```
```{r}
admixture_my_samples <- admixture_long %>% filter(SampleType == "My Sample")
ancestry_colors <- c(
  "Ancestry_1" = "#E69F00",  
  "Ancestry_2" = "#56B4E9",  
  "Ancestry_3" = "#009E73"   
)
ggplot(admixture_my_samples, aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) + 
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions - PRYSMS Samples", 
       x = "Sample", y = "Ancestry Proportion") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```

```{r}
admixture_my_samples <- admixture_my_samples %>%
  group_by(IID) %>%
  arrange(desc(Proportion)) %>%
  ungroup()

ggplot(admixture_my_samples, aes(x = reorder(IID, -Proportion), y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) +
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions - PRYSMS Samples (Sorted)", 
       x = "Sample", y = "Ancestry Proportion") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```
```{r}


ancestry_labels <- c(
  "Ancestry_1" = "African (AFR)",
  "Ancestry_2" = "East Asia (EAS) ",
  "Ancestry_3" = "European (CEU)"
)

ggplot(admixture_my_samples, aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) +  
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions - PRYSMS Samples",
       x = "Sample", y = "Ancestry Proportion", fill = "Ancestry Group") +  
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())  

ggplot(admixture_my_samples, aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = ancestry_colors, labels = ancestry_labels) +  
  theme_minimal() +
  labs(title = "ADMIXTURE Ancestry Proportions - PRYSMS Samples",
       x = "Sample ID", y = "Ancestry Proportion", fill = "Ancestry Group") +  
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))  

```
```{r}
library(pheatmap)


q_matrix <- fread("merged_data.3.Q", header = FALSE)


fam_data <- fread("merged_data.fam", header = FALSE)[, 1:2]
colnames(fam_data) <- c("FID", "IID")


admixture_data <- cbind(fam_data, q_matrix)
colnames(admixture_data)[3:ncol(admixture_data)] <- paste0("Ancestry_", 1:(ncol(admixture_data)-2))


q_matrix_matrix <- as.matrix(admixture_data[, -c(1,2)])


colnames(q_matrix_matrix) <- c("East Asian", "African", "European") 


pheatmap(
  q_matrix_matrix,            
  cluster_cols = FALSE,       
  show_rownames = FALSE,      
  main = "ADMIXTURE Ancestry Proportions Heatmap", 
  labels_col = colnames(q_matrix_matrix)  
)


```
```{r}

my_sample<- read.table("pruned_data.3.Q", header=FALSE)

# Add a column to classify samples
admixture_data$SampleType <- ifelse(admixture_results$IID %in% my_sample$IID, "My Sample", "Reference")

# Print first few rows
head(admixture_results)


pheatmap(
  my_sample,                
  cluster_cols = FALSE,     
  show_rownames = FALSE,    
  main = "ADMIXTURE Ancestry Proportions - PRYSMS Samples",  
  labels_col = colnames(q_matrix_matrix)  
)

```
```{r}
pheatmap(
  my_sample,                
  cluster_cols = FALSE,     
  show_rownames = TRUE,    
  main = "ADMIXTURE Ancestry Proportions - PRYSMS Samples",  
  labels_col = colnames(q_matrix_matrix)  
)

```
```{r}
library(ggplot2)
library(dplyr)
library(data.table)


q_matrix <- fread("merged_data.3.Q", header = FALSE)


fam_data <- fread("merged_data.fam", header = FALSE)[, 1:2]
colnames(fam_data) <- c("FID", "IID")


admixture_results <- cbind(fam_data, q_matrix)


colnames(admixture_results)[3:ncol(admixture_results)] <- paste0("Ancestry_", 1:(ncol(admixture_results) - 2))

head(admixture_results)


pca_results <- prcomp(admixture_results[, 3:ncol(admixture_results)], center = TRUE, scale. = TRUE)


pca_data <- as.data.frame(pca_results$x)


pca_data <- cbind(admixture_results[, 1:2], pca_data)


head(pca_data)

ggplot(pca_data, aes(x = PC1, y = PC2, color = FID)) +
  geom_point(size = 3, alpha = 0.8) +
  theme_minimal() +
  labs(title = "PCA of ADMIXTURE Ancestry Proportions",
       x = "PC1 (Principal Component 1)", 
       y = "PC2 (Principal Component 2)",
       color = "Sample Type")


my_samples <- fread("relationships_w_pops_041510.txt", header = FALSE)[, 1:2]
colnames(my_samples) <- c("FID", "IID")


pca_data$SampleType <- ifelse(pca_data$IID %in% my_samples$IID, "Reference", "Sample")
ggplot(pca_data, aes(x = PC1, y = PC2, color = SampleType)) +
  geom_point(size = 3, alpha = 0.8) +
  theme_minimal() +
  labs(title = "PCA of ADMIXTURE Ancestry Proportions",
       x = "PC1", y = "PC2", color = "Sample Type")

```
```{r}
ggplot(pca_data, aes(x = PC2, y = PC3, color = SampleType)) +
  geom_point(size = 3, alpha = 0.8) +
  theme_minimal() +
  labs(title = "PCA of ADMIXTURE Ancestry Proportions (PC2 vs PC3)",
       x = "PC2", y = "PC3", color = "Sample Type")

```

```{r}

k_3_ancestry <- fread("pruned_data.3.Q", header = FALSE)
k_4_ancestry <- fread("pruned_data.4.Q", header = FALSE)

```

```{r}
library(ggplot2)
library(dplyr)
library(data.table)
library(tidyr)


fam_data <- fread("qc-exome.fam", header = FALSE)[, 1:2]
colnames(fam_data) <- c("FID", "IID")


q_matrix_k3 <- fread("pruned_data.3.Q", header = FALSE)
colnames(q_matrix_k3) <- paste0("Ancestry_", 1:ncol(q_matrix_k3))
q_matrix_k3$K <- "K=3"


q_matrix_k4 <- fread("pruned_data.4.Q", header = FALSE)
colnames(q_matrix_k4) <- paste0("Ancestry_", 1:ncol(q_matrix_k4))
q_matrix_k4$K <- "K=4"


q_matrix_k3 <- cbind(fam_data, q_matrix_k3)
q_matrix_k4 <- cbind(fam_data, q_matrix_k4)


q_matrix_combined <- bind_rows(q_matrix_k3, q_matrix_k4)


q_matrix_long <- q_matrix_combined %>%
  pivot_longer(cols = starts_with("Ancestry_"), names_to = "Ancestry", values_to = "Proportion")

```


```{r}
ancestry_colors <- c(
  "Ancestry_1" = "#E69F00",  
  "Ancestry_2" = "#56B4E9", 
  "Ancestry_3" = "#009E73",  
  "Ancestry_4" = "#D00"   
)

ggplot(q_matrix_long, aes(x = IID, y = Proportion, fill = Ancestry)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ K, scales = "free_x") +
  scale_fill_manual(values = ancestry_colors) +  
  theme_minimal() +
  labs(title = "Comparison of ADMIXTURE Ancestry Proportions (K=3 vs. K=4)",
       x = "Sample", y = "Ancestry Proportion", fill = "Ancestry Group") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```
```{r}
library(dplyr)  
library(data.table)  


admixed_samples <- q_matrix_k4 %>%
  filter(Ancestry_1 > 0.3 & Ancestry_2 > 0.3)


print(admixed_samples)

```

```{r}

Self_reported_data  <- read.csv("/Users/alexisjimenez/Desktop/PRYSMS_self_report_race copy.csv", header = TRUE)
Self_reported_data  <- read.csv("/Users/alexisjimenez/Desktop/particpant ids .csv", header = TRUE)
```

```{r}

library(dplyr)


df <- read.csv("PRYSMS_self_report_race copy.csv")

subset_ids <- read.csv("particpant ids .csv", header = FALSE, col.names = c("id"))


subset_df <- df %>% filter(id %in% subset_ids$id)

head(subset_df)
write.csv(subset_df, "/Users/alexisjimenez/Desktop/subset_self_reported_41_participants.csv", row.names = FALSE)




```

```{r}
# BD2INDIA
count_bd2india <- sum(subset_df$BD2INDIA == "1", na.rm = TRUE)

# BD2OTHER
count_bd2other <- sum(subset_df$BD2OTHER == "1", na.rm = TRUE)

```

```{r}
# Load required libraries
library(dplyr)
library(stringr)




new_q_matrix_k3 <- q_matrix_k3 %>%
  mutate(id = str_extract(IID, "(?<=_)[0-9]+"))

# View result
print(df)


```

```{r}


library(pheatmap)
library(dplyr)

# Load miRNA expression dataset (assuming rows are participants, columns are miRNAs)
mirna_df <- read.csv("PRYSM_miRs_specimen_overlap_AJ_2024_12_15.csv", row.names = 1)


Combined_merged_ADMIX_df <- merge(mirna_df,new_q_matrix_k3, by = "id")

head(Combined_merged_ADMIX_df)

write.csv(Combined_merged_ADMIX_df, "/Users/alexisjimenez/Desktop/combined_merged_ADMIX_df.csv", row.names = FALSE)
```


```{r}

```




